<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Statistics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="/" class="hover:text-blue-500 transition"><i data-lucide="arrow-left"></i></a>
                <h1 class="text-xl font-bold text-slate-900">Attendance Statistics</h1>
            </div>
            <div id="loading" class="text-sm text-slate-400 hidden">Loading...</div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-8">
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b">
                        <tr>
                            <th class="p-4 font-semibold text-slate-600 text-sm">Student Name</th>
                            <th class="p-4 font-semibold text-slate-600 text-sm">Student ID</th>
                            <th class="p-4 font-semibold text-slate-600 text-sm">Date</th>
                            <th class="p-4 font-semibold text-slate-600 text-sm">Time</th>
                            <th class="p-4 font-semibold text-slate-600 text-sm">Shift</th>
                            <th class="p-4 font-semibold text-slate-600 text-sm">Status</th>
                            <th class="p-4 font-semibold text-slate-600 text-sm text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="divide-y divide-slate-100">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="w-full max-w-[380px] mt-10">
            <h3 class="text-slate-500 font-semibold mb-4 uppercase text-xs tracking-wider">Registered Students
            </h3>
            <div id="registeredUsersList" class="flex flex-col gap-3">
                <!-- Loaded via JS -->
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();

        async function fetchStats() {
            const tbody = document.getElementById('statsTableBody');
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');

            try {
                const response = await fetch('/attendance');
                if (!response.ok) throw new Error("Failed to fetch");
                const data = await response.json();
                renderTable(data);
            } catch (err) {
                console.error(err);
                Toastify({ text: "Failed to load statistics", style: { background: "#ef4444" } }).showToast();
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-400">No records found.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const dateObj = new Date(item.date);
                const dateStr = dateObj.toLocaleDateString();
                const timeStr = dateObj.toLocaleTimeString();

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition";
                tr.innerHTML = `
                    <td class="p-4 font-medium">${item.student_name}</td>
                    <td class="p-4 text-slate-500 font-mono text-xs">${item.id_student}</td>
                    <td class="p-4 text-slate-500">${dateStr}</td>
                    <td class="p-4 text-slate-500">${timeStr}</td>
                    <td class="p-4"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-semibold">${item.shift || '-'}</span></td>
                    <td class="p-4"><span class="text-green-600 font-medium flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> ${item.status}</span></td>
                    <td class="p-4 text-right">
                        <button class="delete-btn text-slate-400 hover:text-red-500 transition p-2" onclick="deleteRecord('${item.id}')" title="Delete Record">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        async function deleteRecord(id) {
            if (!confirm("Are you sure you want to delete this record?")) return;

            try {
                const response = await fetch(`/attendance/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    Toastify({ text: "Record deleted", style: { background: "#10b981" } }).showToast();
                    fetchStats();
                } else {
                    const err = await response.json();
                    Toastify({
                        text: `Failed: ${err.detail || err.error || "Unknown error"}`,
                        style: { background: "#ef4444" }
                    }).showToast();
                }
            } catch (err) {
                console.error(err);
                Toastify({ text: "Error deleting record", style: { background: "#ef4444" } }).showToast();
            }
        }

        // Init
        fetchStats();
        // --- Registered Users Logic ---
        const registeredUsersList = document.getElementById('registeredUsersList');

        async function fetchRegisteredUsers() {
            try {
                const response = await fetch('/students');
                if (!response.ok) throw new Error("Failed to fetch");
                const students = await response.json();
                renderRegisteredUsers(students);
            } catch (error) {
                console.error(error);
                registeredUsersList.innerHTML = '<p class="text-red-500 text-sm">Failed to load users.</p>';
            }
        }

        function renderRegisteredUsers(students) {
            registeredUsersList.innerHTML = '';
            if (students.length === 0) {
                registeredUsersList.innerHTML = '<p class="text-slate-400 text-sm italic">No registered students.</p>';
                return;
            }

            students.forEach(student => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center group";
                div.innerHTML = `
                <div>
                    <h4 class="font-medium text-slate-800">${student.name}</h4>
                    <p class="text-xs text-slate-400 font-mono">${student.student_id}</p>
                </div>
                <button class="delete-user-btn text-slate-300 hover:text-red-500 transition p-2" title="Delete User">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;

                const delBtn = div.querySelector('.delete-user-btn');
                delBtn.addEventListener('click', () => deleteUser(student.student_id));

                registeredUsersList.appendChild(div);
            });
        }

        async function deleteUser(studentId) {
            if (!confirm("Are you sure you want to delete this student?")) return;

            try {
                const response = await fetch(`/student/${studentId}`, { method: 'DELETE' });
                if (response.ok) {
                    fetchRegisteredUsers(); // Refresh list
                } else {
                    alert("Failed to delete user");
                }
            } catch (error) {
                console.error(error);
                alert("Error deleting user");
            }
        }


        // Initial Load
        fetchRegisteredUsers();

    </script>
</body>

</html>